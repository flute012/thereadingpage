<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>朗讀閱讀器 Demo</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Zeyada&display=swap');
    .book-title {
      position: absolute;
      top: 20px;
      right: 40px;
      font-family: 'Zeyada', cursive;
      font-size: 2.2em;
      color: rgba(80, 50, 30, 0.8);
      pointer-events: none;
      animation: fadeInUp 1.8s ease-out both;
    }
    @keyframes fadeInUp {
      0% { opacity: 0; transform: translateY(20px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    #audioVisualizer {
      display: flex;
      gap: 3px;
      height: 30px;
      margin-bottom: 15px;
      align-items: end;
      padding: 0 8px;
    }
    #audioVisualizer canvas {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="book-title">The Art of Listening</div>
    <div class="reader-frame">
      <div class="controls">
        <button id="playPauseBtn">▶</button>
        <button id="speedBtn">⏱ <span id="speedValue">1.0x</span></button>
      </div>
      <div id="audioVisualizer">
        <canvas id="visualizerCanvas"></canvas>
      </div>
      <div id="textContainer"></div>
    </div>

    <div id="speedModal">
      <div class="modal-panel">
        <div class="modal-header">語速調整 <span id="modalSpeedValue">1.0x</span></div>
        <input type="range" id="speedSlider" min="0.25" max="2" step="0.05" value="1">
        <div class="speed-presets">
          <button class="speed-btn" data-speed="0.75">0.75x</button>
          <button class="speed-btn active" data-speed="1.0">1.0x</button>
          <button class="speed-btn" data-speed="1.25">1.25x</button>
          <button class="speed-btn" data-speed="1.5">1.5x</button>
        </div>
      </div>
    </div>
  </div>

  <audio id="audio" src="TTS.mp3"></audio>
  <script>
  const audio = document.getElementById('audio');
  const textContainer = document.getElementById('textContainer');
  const playBtn = document.getElementById('playPauseBtn');
  const speedBtn = document.getElementById('speedBtn');
  const speedModal = document.getElementById('speedModal');
  const speedSlider = document.getElementById('speedSlider');
  const modalSpeedValue = document.getElementById('modalSpeedValue');
  const speedValue = document.getElementById('speedValue');

  let wordElements = [];

  const AudioContext = window.AudioContext || window.webkitAudioContext;
  const ctx = new AudioContext();
  const analyser = ctx.createAnalyser();
  const source = ctx.createMediaElementSource(audio);
  source.connect(analyser);
  analyser.connect(ctx.destination);
  analyser.fftSize = 64;

  const bufferLength = analyser.frequencyBinCount;
  const dataArray = new Uint8Array(bufferLength);

  const canvas = document.getElementById('visualizerCanvas');
  const canvasCtx = canvas.getContext('2d');

let glitchCooldown = Array(bufferLength).fill(1.0);

function drawVisualizer() {
  requestAnimationFrame(drawVisualizer);
  analyser.getByteFrequencyData(dataArray);

  const width = canvas.width;
  const height = canvas.height;
  canvasCtx.clearRect(0, 0, width, height);

  const barWidth = (width / bufferLength) * 0.6;
  const gap = barWidth * 0.6;
  let x = 0;

  for (let i = 0; i < bufferLength; i++) {
    const volume = dataArray[i];
    const barHeight = volume / 1.5;
    const hue = 20 + (volume / 255) * 20;
    const alpha = 0.4 + (volume / 255) * 0.6;

    if (Math.random() < 0.01) {
      glitchCooldown[i] = Math.random() * 0.5 + 0.6; // 最小 60% 可見高度
    }
    const visibleHeight = barHeight * glitchCooldown[i];

    const gradient = canvasCtx.createLinearGradient(x, height, x, height - visibleHeight);
    gradient.addColorStop(0, `hsla(${hue}, 85%, 48%, 0.1)`);
    gradient.addColorStop(0.6, `hsla(${hue}, 85%, 55%, ${alpha})`);
    gradient.addColorStop(1, `hsla(${hue}, 85%, 70%, 0)`);

    canvasCtx.fillStyle = gradient;
    canvasCtx.fillRect(x, height - visibleHeight, barWidth, visibleHeight);
    x += barWidth + gap;
  }
}

  canvas.width = canvas.offsetWidth;
  canvas.height = canvas.offsetHeight;

  drawVisualizer();

  // JSON 資料
  fetch('The Open Window.json')
    .then(res => res.json())
    .then(data => {
      const paragraphs = data[Object.keys(data)[0]].paragraphs;
      for (let key in paragraphs) {
        const wrapper = document.createElement('div');
        wrapper.className = 'paragraph';
        wrapper.innerHTML = paragraphs[key].english_with_html;
        textContainer.appendChild(wrapper);
      }
      wordElements = Array.from(document.querySelectorAll('span[data-start]'));
      wordElements.forEach(span => {
        span.style.cursor = 'pointer';
        span.addEventListener('click', () => {
          const start = parseFloat(span.dataset.start);
          if (!isNaN(start)) {
            audio.currentTime = start;
            audio.play();
            playBtn.textContent = '⏸';
          }
        });
      });
    });


  playBtn.addEventListener('click', () => {
    if (ctx.state === 'suspended') ctx.resume();
    if (audio.paused) {
      audio.play();
      playBtn.textContent = '⏸';
    } else {
      audio.pause();
      playBtn.textContent = '▶';
    }
  });

  audio.addEventListener('timeupdate', () => {
    const t = audio.currentTime;
    wordElements.forEach(span => {
      const start = parseFloat(span.dataset.start);
      const end = parseFloat(span.dataset.end);
      if (t >= start && t <= end) {
        span.classList.add('highlight');
      } else {
        span.classList.remove('highlight');
      }
    });
  });
    
  // 語速控制
  speedBtn.addEventListener('click', () => {
    speedModal.style.display = 'block';
  });
  speedSlider.addEventListener('input', (e) => {
    const val = parseFloat(e.target.value);
    audio.playbackRate = val;
    modalSpeedValue.textContent = `${val.toFixed(2)}x`;
    speedValue.textContent = `${val.toFixed(2)}x`;
  });
  document.querySelectorAll('.speed-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const s = parseFloat(btn.dataset.speed);
      audio.playbackRate = s;
      speedSlider.value = s;
      modalSpeedValue.textContent = `${s.toFixed(2)}x`;
      speedValue.textContent = `${s.toFixed(2)}x`;
      document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    });
  });
  speedModal.addEventListener('click', e => {
    if (e.target === speedModal) speedModal.style.display = 'none';
  });
  </script>
</body>
</html>
